<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>EndlessDDD - æ­£åœ¨å¯åŠ¨</title>
    <style>
      body {
        margin: 0;
        padding: 0;
        height: 100vh;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
      }

      .loading-container {
        text-align: center;
        color: white;
        max-width: 450px;
        padding: 2rem;
      }

      .loading-logo {
        width: 80px;
        height: 80px;
        margin-bottom: 2rem;
        animation: pulse 2s infinite;
      }

      .loading-title {
        font-size: 2rem;
        font-weight: 600;
        margin-bottom: 1rem;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
      }

      .loading-subtitle {
        font-size: 1.1rem;
        margin-bottom: 2rem;
        opacity: 0.9;
      }

      .loading-progress {
        background: rgba(255, 255, 255, 0.2);
        border-radius: 10px;
        height: 8px;
        margin-bottom: 1rem;
        overflow: hidden;
        position: relative;
      }

      .loading-progress-bar {
        background: linear-gradient(90deg, #4ade80, #22c55e);
        height: 100%;
        border-radius: 10px;
        transition: width 0.5s ease;
        position: relative;
      }

      .loading-progress-bar::after {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.3),
          transparent
        );
        animation: shimmer 2s infinite;
      }

      .loading-status {
        font-size: 0.9rem;
        opacity: 0.8;
        margin-bottom: 1rem;
        min-height: 1.2em;
      }

      .loading-steps {
        text-align: left;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 10px;
        padding: 1rem;
        margin-top: 1rem;
        max-height: 200px;
        overflow-y: auto;
      }

      .loading-step {
        display: flex;
        align-items: center;
        margin-bottom: 0.8rem;
        font-size: 0.9rem;
        padding: 0.5rem;
        border-radius: 5px;
        transition: all 0.3s ease;
      }

      .loading-step-icon {
        margin-right: 0.8rem;
        width: 20px;
        text-align: center;
        font-size: 1.1rem;
      }

      .loading-step.completed {
        background: rgba(74, 222, 128, 0.1);
        border-left: 3px solid #4ade80;
      }

      .loading-step.completed .loading-step-icon {
        color: #4ade80;
      }

      .loading-step.pending {
        opacity: 0.6;
      }

      .loading-step.pending .loading-step-icon {
        color: #6b7280;
      }

      .loading-step.active {
        background: rgba(251, 191, 36, 0.1);
        border-left: 3px solid #fbbf24;
      }

      .loading-step.active .loading-step-icon {
        color: #fbbf24;
        animation: spin 1s linear infinite;
      }

      .loading-step.error {
        background: rgba(239, 68, 68, 0.1);
        border-left: 3px solid #ef4444;
      }

      .loading-step.error .loading-step-icon {
        color: #ef4444;
      }

      .step-details {
        font-size: 0.8rem;
        opacity: 0.7;
        margin-top: 0.2rem;
        margin-left: 2.8rem;
      }

      @keyframes pulse {
        0%,
        100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.05);
        }
      }

      @keyframes shimmer {
        0% {
          transform: translateX(-100%);
        }
        100% {
          transform: translateX(100%);
        }
      }

      @keyframes spin {
        from {
          transform: rotate(0deg);
        }
        to {
          transform: rotate(360deg);
        }
      }

      .error-container {
        display: none;
        background: rgba(239, 68, 68, 0.9);
        border-radius: 10px;
        padding: 1rem;
        margin-top: 1rem;
      }

      .retry-button {
        background: rgba(255, 255, 255, 0.2);
        border: 1px solid rgba(255, 255, 255, 0.3);
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 5px;
        cursor: pointer;
        margin-top: 1rem;
        transition: all 0.3s ease;
      }

      .retry-button:hover {
        background: rgba(255, 255, 255, 0.3);
      }

      .loading-time {
        font-size: 0.8rem;
        opacity: 0.6;
        margin-top: 1rem;
      }
    </style>
  </head>
  <body>
    <div class="loading-container">
      <img
        alt="EndlessDDD"
        class="loading-logo"
        src="image/endless-favicon-16.svg" />
      <h1 class="loading-title">EndlessDDD</h1>
      <p class="loading-subtitle">æ­£åœ¨å¯åŠ¨ Spring Boot æœåŠ¡...</p>

      <div class="loading-progress">
        <div class="loading-progress-bar" id="progressBar"></div>
      </div>

      <div class="loading-status" id="statusText">æ­£åœ¨åˆå§‹åŒ–...</div>

      <div class="loading-steps">
        <div class="loading-step pending" id="step1">
          <div class="loading-step-icon">â³</div>
          <div>
            <div>æ£€æŸ¥ç¯å¢ƒé…ç½®</div>
            <div class="step-details" id="step1-details">
              éªŒè¯Javaç¯å¢ƒã€æ£€æŸ¥JARæ–‡ä»¶
            </div>
          </div>
        </div>
        <div class="loading-step pending" id="step2">
          <div class="loading-step-icon">â³</div>
          <div>
            <div>å¯åŠ¨ Spring Boot è¿›ç¨‹</div>
            <div class="step-details" id="step2-details">
              å¯åŠ¨Javaè¿›ç¨‹ï¼ŒåŠ è½½Spring Bootåº”ç”¨
            </div>
          </div>
        </div>
        <div class="loading-step pending" id="step3">
          <div class="loading-step-icon">â³</div>
          <div>
            <div>ç­‰å¾…æœåŠ¡å°±ç»ª</div>
            <div class="step-details" id="step3-details">
              å¥åº·æ£€æŸ¥ï¼Œç­‰å¾…ç«¯å£å¼€æ”¾
            </div>
          </div>
        </div>
        <div class="loading-step pending" id="step4">
          <div class="loading-step-icon">â³</div>
          <div>
            <div>åŠ è½½åº”ç”¨ç•Œé¢</div>
            <div class="step-details" id="step4-details">
              åˆ‡æ¢åˆ°ä¸»çª—å£ï¼Œå®Œæˆå¯åŠ¨
            </div>
          </div>
        </div>
      </div>

      <div class="loading-time" id="loadingTime">å¯åŠ¨æ—¶é—´: 0ç§’</div>

      <div class="error-container" id="errorContainer">
        <div id="errorMessage"></div>
        <button class="retry-button" onclick="retryConnection()">
          é‡è¯•è¿æ¥
        </button>
      </div>
    </div>

    <script>
      let currentStep = 0;
      let retryCount = 0;
      const maxRetries = 3;
      let startTime = Date.now();
      let loadingCompleted = false;
      let tauriEventsReceived = false;

      const steps = [
        {
          id: "step1",
          text: "æ£€æŸ¥ç¯å¢ƒé…ç½®",
          details: "éªŒè¯Javaç¯å¢ƒã€æ£€æŸ¥JARæ–‡ä»¶",
          progress: 10,
        },
        {
          id: "step2",
          text: "å¯åŠ¨ Spring Boot è¿›ç¨‹",
          details: "å¯åŠ¨Javaè¿›ç¨‹ï¼ŒåŠ è½½Spring Bootåº”ç”¨",
          progress: 30,
        },
        {
          id: "step3",
          text: "ç­‰å¾…æœåŠ¡å°±ç»ª",
          details: "å¥åº·æ£€æŸ¥ï¼Œç­‰å¾…ç«¯å£å¼€æ”¾",
          progress: 60,
        },
        {
          id: "step4",
          text: "åŠ è½½åº”ç”¨ç•Œé¢",
          details: "åˆ‡æ¢åˆ°ä¸»çª—å£ï¼Œå®Œæˆå¯åŠ¨",
          progress: 90,
        },
      ];

      function updateStep(stepIndex, status = "active") {
        // é‡ç½®æ‰€æœ‰æ­¥éª¤çŠ¶æ€
        steps.forEach((step, index) => {
          const stepElement = document.getElementById(step.id);
          if (index < stepIndex) {
            stepElement.className = "loading-step completed";
            stepElement.querySelector(".loading-step-icon").textContent = "âœ…";
          } else if (index === stepIndex) {
            stepElement.className = `loading-step ${status}`;
            stepElement.querySelector(".loading-step-icon").textContent =
              status === "error" ? "âŒ" : "ğŸ”„";
          } else {
            stepElement.className = "loading-step pending";
            stepElement.querySelector(".loading-step-icon").textContent = "â³";
          }
        });

        if (stepIndex < steps.length) {
          document.getElementById("statusText").textContent =
            steps[stepIndex].text;
          document.getElementById(
            `${steps[stepIndex].id}-details`,
          ).textContent = steps[stepIndex].details;
        }
      }

      function updateProgress(percentage) {
        document.getElementById("progressBar").style.width = percentage + "%";
      }

      function updateLoadingTime() {
        const elapsed = Math.floor((Date.now() - startTime) / 1000);
        document.getElementById(
          "loadingTime",
        ).textContent = `å¯åŠ¨æ—¶é—´: ${elapsed}ç§’`;
      }

      function showError(message) {
        document.getElementById("errorMessage").textContent = message;
        document.getElementById("errorContainer").style.display = "block";
        document.getElementById("statusText").textContent = "å¯åŠ¨å¤±è´¥";
        updateStep(currentStep, "error");
      }

      function hideError() {
        document.getElementById("errorContainer").style.display = "none";
      }

      async function checkSpringBootStatus() {
        try {
          const response = await fetch("/actuator/health", {
            method: "GET",
            headers: {
              "Cache-Control": "no-cache",
            },
          });
          return response.ok;
        } catch (error) {
          console.log("Spring Boot æœåŠ¡æ£€æŸ¥å¤±è´¥:", error.message);
          return false;
        }
      }

      async function waitForSpringBoot() {
        const maxAttempts = 60;
        let attempts = 0;

        while (attempts < maxAttempts) {
          if (await checkSpringBootStatus()) {
            return true;
          }
          attempts++;
          await new Promise((resolve) => setTimeout(resolve, 500));
        }
        return false;
      }

      async function retryConnection() {
        hideError();
        retryCount++;

        if (retryCount > maxRetries) {
          showError("è¿æ¥å¤±è´¥æ¬¡æ•°è¿‡å¤šï¼Œè¯·æ£€æŸ¥ Spring Boot æœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œã€‚");
          return;
        }

        document.getElementById(
          "statusText",
        ).textContent = `é‡è¯•è¿æ¥ (${retryCount}/${maxRetries})...`;

        if (await waitForSpringBoot()) {
          completeLoading();
        } else {
          showError("æ— æ³•è¿æ¥åˆ° Spring Boot æœåŠ¡ï¼Œè¯·æ£€æŸ¥æœåŠ¡çŠ¶æ€ã€‚");
        }
      }

      function completeLoading() {
        if (loadingCompleted) return;

        loadingCompleted = true;
        updateStep(3);
        updateProgress(100);
        document.getElementById("statusText").textContent = "å¯åŠ¨å®Œæˆï¼";

        setTimeout(() => {
          window.location.href = "../index.html";
        }, 1000);
      }

      function setupTauriEventListeners() {
        if (!window.__TAURI__) {
          console.log("âš ï¸ æœªæ£€æµ‹åˆ°Tauriï¼Œä½¿ç”¨ä¼ ç»Ÿæ–¹å¼ç­‰å¾…");
          return false;
        }

        console.log("ğŸ“¡ è®¾ç½®Tauriäº‹ä»¶ç›‘å¬å™¨...");

        // ç›‘å¬Spring Bootå¯åŠ¨å¼€å§‹äº‹ä»¶
        window.__TAURI__.event.listen("spring-boot-starting", (event) => {
          console.log("ğŸš€ Spring Bootå¼€å§‹å¯åŠ¨:", event.payload);
          tauriEventsReceived = true;
          currentStep = 1;
          updateStep(currentStep);
          updateProgress(steps[currentStep].progress);
          document.getElementById("step1-details").textContent = event.payload;
        });

        // ç›‘å¬Spring Bootè¿›ç¨‹å¯åŠ¨äº‹ä»¶
        window.__TAURI__.event.listen("spring-boot-started", (event) => {
          console.log("ğŸ“¦ Spring Bootè¿›ç¨‹å·²å¯åŠ¨:", event.payload);
          tauriEventsReceived = true;
          currentStep = 2;
          updateStep(currentStep);
          updateProgress(steps[currentStep].progress);
          document.getElementById("step2-details").textContent = event.payload;
        });

        // ç›‘å¬å¥åº·æ£€æŸ¥äº‹ä»¶
        window.__TAURI__.event.listen("spring-boot-health-check", (event) => {
          console.log("ğŸ” å¥åº·æ£€æŸ¥:", event.payload);
          document.getElementById("step3-details").textContent = event.payload;
        });

        // ç›‘å¬å¥åº·æ£€æŸ¥è¿›åº¦äº‹ä»¶
        window.__TAURI__.event.listen(
          "spring-boot-health-progress",
          (event) => {
            console.log("â³ å¥åº·æ£€æŸ¥è¿›åº¦:", event.payload);
            document.getElementById("step3-details").textContent =
              event.payload;
            // æ›´æ–°è¿›åº¦æ¡æ˜¾ç¤ºç­‰å¾…çŠ¶æ€
            updateProgress(60 + (currentStep === 2 ? 10 : 0));
          },
        );

        // ç›‘å¬å¥åº·æ£€æŸ¥æˆåŠŸäº‹ä»¶
        window.__TAURI__.event.listen("spring-boot-health-success", (event) => {
          console.log("âœ… å¥åº·æ£€æŸ¥æˆåŠŸ:", event.payload);
          document.getElementById("step3-details").textContent = event.payload;
        });

        // ç›‘å¬Spring BootæœåŠ¡å°±ç»ªäº‹ä»¶
        window.__TAURI__.event.listen("spring-boot-ready", (event) => {
          console.log("âœ… Spring BootæœåŠ¡å·²å°±ç»ª:", event.payload);
          tauriEventsReceived = true;
          if (!loadingCompleted) {
            currentStep = 3;
            updateStep(currentStep);
            updateProgress(steps[currentStep].progress);
            document.getElementById("step3-details").textContent =
              "å¥åº·æ£€æŸ¥é€šè¿‡ï¼ŒæœåŠ¡å·²å°±ç»ª";
            console.log("ğŸ‰ æ”¶åˆ°readyäº‹ä»¶ï¼Œå‡†å¤‡è·³è½¬...");
            completeLoading();
          }
        });

        // ç›‘å¬çª—å£åˆ‡æ¢äº‹ä»¶
        window.__TAURI__.event.listen("spring-boot-switching", (event) => {
          console.log("ğŸ”„ çª—å£åˆ‡æ¢:", event.payload);
          document.getElementById("step4-details").textContent = event.payload;
        });

        // ç›‘å¬Spring Bootå¯åŠ¨é”™è¯¯äº‹ä»¶
        window.__TAURI__.event.listen("spring-boot-error", (event) => {
          console.error("âŒ Spring Bootå¯åŠ¨å¤±è´¥:", event.payload);
          tauriEventsReceived = true;
          if (!loadingCompleted) {
            loadingCompleted = true;
            updateStep(currentStep, "error");
            showError(event.payload);
          }
        });

        return true;
      }

      async function startLoading() {
        try {
          console.log("ğŸš€ å¼€å§‹åŠ è½½æµç¨‹...");
          startTime = Date.now();

          // å¯åŠ¨æ—¶é—´æ›´æ–°å®šæ—¶å™¨
          const timeInterval = setInterval(() => {
            if (!loadingCompleted) {
              updateLoadingTime();
            } else {
              clearInterval(timeInterval);
            }
          }, 1000);

          // æ­¥éª¤1: æ£€æŸ¥ç¯å¢ƒé…ç½®
          currentStep = 0;
          updateStep(currentStep);
          updateProgress(steps[currentStep].progress);
          await new Promise((resolve) => setTimeout(resolve, 1000));

          // è®¾ç½®Tauriäº‹ä»¶ç›‘å¬å™¨
          const tauriAvailable = setupTauriEventListeners();

          if (tauriAvailable) {
            // ä½¿ç”¨Tauriäº‹ä»¶é©±åŠ¨çš„æ–¹å¼
            console.log("ğŸ” ç­‰å¾…Tauriäº‹ä»¶...");

            // åŒæ—¶è¿›è¡Œå¥åº·æ£€æŸ¥ä½œä¸ºå¤‡ç”¨æ–¹æ¡ˆ
            let healthCheckAttempts = 0;
            const maxHealthCheckAttempts = 60; // 30ç§’
            let healthCheckCompleted = false;

            const healthCheckInterval = setInterval(async () => {
              if (loadingCompleted) {
                console.log("ğŸ›‘ åŠ è½½å·²å®Œæˆï¼Œåœæ­¢å¥åº·æ£€æŸ¥");
                clearInterval(healthCheckInterval);
                return;
              }

              healthCheckAttempts++;
              console.log(
                `ğŸ” å¥åº·æ£€æŸ¥å°è¯• ${healthCheckAttempts}/${maxHealthCheckAttempts}`,
              );

              if (await checkSpringBootStatus()) {
                console.log("âœ… å¥åº·æ£€æŸ¥æˆåŠŸï¼ŒæœåŠ¡å·²å°±ç»ª");
                clearInterval(healthCheckInterval);
                healthCheckCompleted = true;

                if (!loadingCompleted && !tauriEventsReceived) {
                  // å¦‚æœTauriäº‹ä»¶æ²¡æœ‰è§¦å‘ï¼Œä½†å¥åº·æ£€æŸ¥æˆåŠŸï¼Œç›´æ¥å®Œæˆ
                  console.log("ğŸ‰ å¥åº·æ£€æŸ¥æˆåŠŸï¼Œå‡†å¤‡è·³è½¬...");
                  currentStep = 3;
                  updateStep(currentStep);
                  updateProgress(steps[currentStep].progress);
                  completeLoading();
                }
              } else if (healthCheckAttempts >= maxHealthCheckAttempts) {
                console.log("â° å¥åº·æ£€æŸ¥è¶…æ—¶ï¼Œä½†ç»§ç»­ç­‰å¾…Tauriäº‹ä»¶");
                clearInterval(healthCheckInterval);
              }
            }, 500);

            // è®¾ç½®ä¸€ä¸ªæœ€ç»ˆè¶…æ—¶ï¼Œå¦‚æœ60ç§’åè¿˜æ²¡æœ‰è·³è½¬ï¼Œå¼ºåˆ¶è·³è½¬
            setTimeout(() => {
              if (!loadingCompleted) {
                console.log("â° æœ€ç»ˆè¶…æ—¶ï¼Œå¼ºåˆ¶è·³è½¬åˆ°ä¸»ç•Œé¢");
                loadingCompleted = true;
                completeLoading();
              }
            }, 60000);
          } else {
            // ä¼ ç»Ÿæ–¹å¼ï¼šæ¨¡æ‹Ÿæ­¥éª¤è¿›åº¦
            console.log("ğŸ“‹ ä½¿ç”¨ä¼ ç»ŸåŠ è½½æ–¹å¼...");

            for (let i = 1; i < steps.length; i++) {
              currentStep = i;
              updateStep(currentStep);
              updateProgress(steps[currentStep].progress);

              if (i === 2) {
                // ç­‰å¾…Spring BootæœåŠ¡å°±ç»ª
                if (await waitForSpringBoot()) {
                  document.getElementById("step3-details").textContent =
                    "å¥åº·æ£€æŸ¥é€šè¿‡ï¼ŒæœåŠ¡å·²å°±ç»ª";
                } else {
                  showError("Spring Boot æœåŠ¡å¯åŠ¨è¶…æ—¶ï¼Œè¯·æ£€æŸ¥æœåŠ¡çŠ¶æ€ã€‚");
                  return;
                }
              }

              await new Promise((resolve) => setTimeout(resolve, 1000));
            }

            completeLoading();
          }
        } catch (error) {
          console.error("åŠ è½½è¿‡ç¨‹å‡ºé”™:", error);
          showError("å¯åŠ¨è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: " + error.message);
        }
      }

      // é¡µé¢åŠ è½½å®Œæˆåç«‹å³å¼€å§‹åŠ è½½æµç¨‹
      document.addEventListener("DOMContentLoaded", startLoading);
    </script>
  </body>
</html>
